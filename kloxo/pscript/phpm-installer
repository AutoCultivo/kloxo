#!/bin/sh

echo "*** BEGIN '$1' install ***"

base_name="${1}"
## MR -- remove last char (default m or s)
src_name="${base_name%?}"

if [ "$(yum list php*|grep ${src_name}u)" != "" ] ; then
	pack_name="${src_name}u"
elif [ "$(yum list php*|grep ${src_name})" != "" ] ; then
	pack_name="${src_name}"
#elif [ "$(yum list lsphp*|grep ${src_name})" != "" ] ; then
#	pack_name="${src_name}"
else
	echo "- No PHP packages exists. Only detecting '${src_name}u' and '${src_name}'. Exit"
	echo
	exit
fi

#if [ "$(yum list *yum*|grep @)" != "" ] ; then
#	mysqlapp="mysql"
#else
#	mysqlapp="mysql55"
#fi

if [ "$(uname -m)" == "x86_64" ] ; then
	v=".x86_64"
else
	v=""
fi

echo "- Install php general dependencies rpms... Please wait!"
yum -y install apr${v} apr-util${v} aspell${v} atk${v} avahi-libs${v} bzip2${v} cairo${v} ConsoleKit${v} ConsoleKit-libs${v} cups-libs${v} \
	curl${v} cyrus-sasl${v} db4${v} dbus${v} e2fsprogs${v} eggdbus${v} elfutils-libelf${v} enchant${v} expat${v} file${v} \
	fileutils${v} fontconfig${v} freetds${v} freetype${v} GConf2${v} gcc-c++${v} gd${v} GeoIP${v} ghostscript${v} ghostscript-fonts${v} \
	gmp${v} gtk2${v} hicolor-icon-theme${v} icui18n${v} ilmbase${v} ImageMagick${v} jasper-libs${v} krb5${v} lcms-libs${v} libc-client${v} \
	libcroco${v} libedit${v} libevent${v} libfontenc${v} libgomp${v} libgsf${v} libicu${v} libIDL${v} libjpeg${v} liblzf${v} \
	libmcrypt${v} libmemcached${v} libpng${v} librsvg2${v} libSM${v} libstdc++${v} libthai${v} libtiff${v} libtool${v} libtool-ltdl${v} \
	libwmf-lite${v} libxml2${v} libxslt${v} libtidy${v} libvpx${v} libXpm${v} libXcomposite${v} libXcursor${v} libXdamage${v} libXext${v} \
	libXfixes${v} libXfont${v} libXft${v} libXi${v} libXinerama${v} libXrandr${v} libXrender${v} libXt${v} lm_sensors${v} lm_sensors-libs${v} \
	mhash${v} ncurses${v} net-snmp${v} OpenEXR-libs${v} openldap${v} openssl${v} ORBit2${v} pam${v} pango${v} perl${v} polkit${v} \
	postgresql${v} pspell${v} recode${v} redhat-lsb${v} sgml-common${v} sqlite${v} t1lib${v} unixODBC${v} urw-fonts${v} \
	xorg-x11-font-utils${v} zlib${v} redis{v} >/dev/null 2>&1


echo "- Download '${base_name}' all rpms... Please wait!"
mkdir -p /opt/${base_name}
cd /opt/${base_name}
yumdownloader ${pack_name}-*  >/dev/null 2>&1
rm -rf *-debug*
rm -rf *-devel*

echo "- Extract '${base_name}' all rpms..."
for entry in $(ls ./*.rpm) ; do
	rpm2cpio $entry | cpio -idmv >/dev/null 2>&1
done

rm -rf *.rpm

echo "- Disable '${base_name}' certain modules..."
for i in dba dbase eaccelerator ioncube pdo_dblib pdo_odbc pdo_pgsql pgsql suhosin odbc mongo \
	apc apcu imagick interbase ioncube-loader memcache memcached mssql debug \
	pdo_dblib pdo_firebird mysqlnd_ms mysqlnd_mysql mysqlnd_mysqli mysqlnd pdo_mysqlnd \
	xdebug	xcache opcache lzf redis enchant ; do

	if [ -f /opt/${base_name}/etc/php.d/${i}.ini ] ; then
		if [ "$(echo ${i}|grep mysqlnd)" != "" ] ; then
			## MR -- using mysqlnd instead mysql/mysqli in php54s
			if [ -f /opt/${base_name}/etc/php.d/mysql.ini ] ; then
				mv -f /opt/${base_name}/etc/php.d/mysql.ini /opt/${base_name}/etc/php.d/mysql.nonini
				mv -f /opt/${base_name}/etc/php.d/mysqli.ini /opt/${base_name}/etc/php.d/mysqli.nonini
				mv -f /opt/${base_name}/etc/php.d/pdo_mysql.ini /opt/${base_name}/etc/php.d/pdo_mysql.nonini
			fi
		else
			mv -f /opt/${base_name}/etc/php.d/${i}.ini /opt/${base_name}/etc/php.d/${i}.nonini
		fi
	fi
done

cd /

sh /script/phpm-config-setup $base_name

echo "*** END '$1' install ***"
echo

